% !Mode:: "TeX:UTF-8"
%% 请使用 XeLaTeX 编译本文.
% \documentclass{WHUBachelor}% 选项 forprint: 交付打印时添加, 避免彩色链接字迹打印偏淡. 即使用下一行:
  \documentclass[forprint]{WHUBachelor}

  \begin{document}
  %%%%%%% 下面的内容, 据实填空.
  
  \miji{ 2016级}                                      % 密级. 没有就空着.
  \StudentNumber{16337259(谢江钊)} % 填写自己的学号
  
  \title{基于流水线CPU的分支预测技术性能研究}
  \Etitle{Research on the Performance of Branch Prediction Technology Based on Pipeline CPU} % 英文题目
  \author{谢江钊}                            % 作者名字
  \Eauthor{Xie Jiangzhao}            %作者英文名
  \Csupervisor{李国桢\quad 教授}        %指导教师中文名、职称
  \Esupervisor{Prof.~Li Guozhen}     %指导教师英文名、职称
  \Cmajor{计算机类}                  % 专业中文名
  \Emajor{Computer Class}% 专业英文名
  \Cschoolname{数据科学与计算机学院}          % 学院名
  \Eschoolname{School of Data and Computer Science} %学院英文名. 不确定的话, 请看一下自己学院的网页上是怎么写的. 别搞错了!
  \date{二〇一八年一月}                    % 日期, 要注意和英文日期一致!!
  \Edate{January, 2018}                       % 英文封面日期
  
  %-----------------------------------------------------------------------------
  \pdfbookmark[0]{封面}{title}         % 封面页加到 pdf 书签
  \maketitle
  \frontmatter
  \pagenumbering{Roman}              % 正文之前的页码用大写罗马字母编号.
  %-----------------------------------------------------------------------------
  \include{includefile/frontmatter}    % 加入摘要, 申明.
  %==========================把目录加入到书签==============================%%%%%%
  \pdfbookmark[0]{目录}{toc}
  \tableofcontents
  \mainmatter %% 以下是正文
  %%%%%%%%%%%%%%%%%%%%%%%%%%%--------main matter-------%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \chapter{绪论}
   \section{分支预测算法的意义}
  
   分支预测器的重要性在课本中已经得到相当详尽的论述，在这里就不再从原理上去解释它了。回到工业生产中去，
近年来CPU的发展是巨大的，技术的更新集中在更高的制程，频率，深流水线，指令集并行，超线程技术等等上。其中
的流水线加深，更是使得条件分支带来的控制冲突变得日趋严重。分支预测进行得不准确，意味着预测的指令全部都
要抛弃不再进行，这一点会导致极大的性能浪费。其中，奔腾4便是一个失败的例子。奔腾4采用的31级超长流水线，
把主频提高到了3Ghz以上，但是性能却比不过同时期低主频14级流水线的AMD处理器，其中一个重要的原因便是没有
采用高效的分支预测器，导致流水线中断问题极其严重，导致了性能的严重下降。今天的CPU普遍采用14-16级流水线原因之一，
便是分支预测技术瓶颈。\par
业界引入了动态分支预测技术，开发出多种预测方案，使得控制冲突逐渐得到解决。其中较为贴近现代的便是局部分支
预测器，全局分支预测器，循环分支预测器以及间接分支预测器等等，在这里我将对一部分方案作出解释。另外，由
S. McFarling提出的混合（融合）分支预测器相比之下会有更加好的预测结果，同样非常值得考虑作为CPU预测器
发展的方向。\par
更前沿地，当前高端CPU已经迈进了神经网络预测以及多种预测器相结合的道路，在这里由于技术过于复杂便不再进行赘述。
预测器的发展需要考虑到速度和效果，这一点也是需要企业来进行权衡的。如何平衡两者的关系，也是未来发展的一个重点。
做这个项目的时候感触良多，对指令执行特点和CPU自身设计有了很多的体会。而这一个项目实现的内容将来也能够不断改进，
作为未来的教学预测性能预测手段。
  \section{技术发展现状与趋势}\label{sec-compile}

  \subsection{静态分支预测技术}
静态分支技术是最简单的技术，分为两种，强制跳转或强制不跳，而不依赖于过去的历史记录。后来的技术变得更加复杂，假定了
向后分支必然发生，而向前的分支不会发生，对应着程序设计中经常使用到的for循环和if判断特性，能够更好地进行预测。在
早期的时候一些处理器甚至允许分支预测提示出现在代码中，但是后来便不再采用。对于这种做法，理论上是不应该存在的，对于
程序员来说，底层的CPU实现应该做到透明，而不是反过来去负责做分支预测。\par
静态分支预测技术的优点在于对硬件实现基本没有要求，但是预测的效果却见不得理想，尤其对于日渐复杂的程序而言，其准确率
是不能够被接受的。


  \subsection{1bit分支预测器}
1bit分支预测器引入了一位分支预测缓存,记录分支最后一次的选择，然后预测下一次也做出同样的决定。但是这种预测方法有一个
问题在于，如果遇到TFTFTFT...的情况，会造成大量的空翻，从而使得性能被严重浪费。并且由于其总是预测分支跳转/不跳转一定
发生，一旦出现例外情况就会造成两次错误。为了解决这个问题，引入2bit分支预测器，来给预测引入一个缓冲区域。

  
  
  
  \subsection{2bit分支预测器}
2bit分支预测器是基于饱和计数器进行的，饱和计数器是一个拥有4个状态的状态机:强跳转，弱跳转，弱不跳转，他们之间的相互转换关系如下:\par
\begin{figure}[ht]
  \centering
    \includegraphics[width=\textwidth]{Counter.png}
    \caption{饱和计数器\upcite{r2}}
    \label{fig:1}
  \end{figure}
2bit分支预测器以跳转指令的PC地址作为索引，然后查找到对应的饱和计数器，根据高位输出结果:\par
\begin{figure}[ht]
  \centering
    \includegraphics[width=\textwidth]{2bit.png}
    \caption{2bit分支预测器\upcite{r1}}
    \label{fig:2}
  \end{figure}
这种方法的优点在于指令必须选择某个分支连续两次，才能够实现状态的翻转，进而改变预测的分支。回到刚才的情况，一开始的时候
饱和计数器处于强跳转的状态，那么一次F的影响只能使计数器回到弱跳转状态，避免了接连的空翻，相比之下错误率下降。同样的道理，
我们还可以提出nbit分支预测器，来给予更多的缓冲空间，但是这种做法也导致了跳转不能够灵活地得到改变，在测试中反而导致预测率
下降。

 \subsection{局部分支预测器}
 前面所描述的2bit分支预测器，用状态机的办法把过去若干条指令改变的结果保存了下来，但是这样有一个问题，认为本次的跳转与
 之前的若干条指令跳转有关，但是处理起来却把本次预测结果应该基于过去的情况。举个例子，假如之前的几次跳转结果是TTF，那么
 这一次的结果如果仅仅看作前几次的衍生的话，便有可能出错。例如对于一个循环而言，循环3次跳转最后一次不跳转(跳出循环)，如果
 依靠2bit分支预测器就会出现预测错误的结果，因为前三次的跳转不能够表明这一次也一定跳转。相对应的是，我们可以把前三次的历史
 记录看作是一种模式，然后在此基础上构建饱和计数器，经过若干次训练，便可以得到一个结果:三次的跳转必然伴随着一次结果，这样我们
 往后的预测便会变得准确，提高了我们的正确率。\par
 \begin{figure}[ht]
  \centering
    \includegraphics[width=\textwidth]{Local.png}
    \caption{局部分支预测器\upcite{r1}}
    \label{fig:3}
  \end{figure}
 局部分支预测器构建了两个表:一个被称为BHT(Branch History Table)，另一个被称为BPT(Branch Pattern Table)。BHT以跳转指令的
 地址作为索引，记录改分支的历史记录，然后根据分支的历史记录去查询对应的饱和计数器，根据计数器的高位进行相对应预测。预测的结果
 同样会不断更新历史和计数器。在经过大量训练后便可以得到相当优秀的正确率。这种预测方式被现代CPU普遍地采纳。

 \subsection{全局分支预测器}
 局部分支预测器仅仅通过指令自身的预测历史预测了指令的跳转，但是却没有考虑到指令之间的相关性。对于某些指令，例如\par
 if(a>0) todo;\par
if(a<=0) todo;\par
第一条指令和第二条指令必然只会发生一条，通过观察第一条指令的跳转情况便可以预测第二条指令的跳转结果。对于一个不断变化的a，这个
时候局部分支预测器便不能仅仅通过自身的历史记录来推测出下一次跳转情况。因此，全局分支预测器采取的做法是，记录下前几条指令的跳转情况，
然后通过这个历史记录来查找对应的饱和计数器，从而解决了跳转指令的相关问题。\par
全局分支预测器通过GR(Global History)来索引饱和计数器，获得对应的预测结果。\par
\begin{figure}[ht]
  \centering
    \includegraphics[width=\textwidth]{Global.png}
    \caption{全局分支预测器\upcite{r1}}
    \label{fig:3}
  \end{figure}

\subsection{混合分支预测器}
相比以上两种分支预测器，混合分支预测器仅仅是简单地将他们组合起来，从而在面对复杂的分支情况时能够更有效地采取不同的预测器，获得更加优秀
的表现。混合分支预测器将预测的任务分别交给全局分支预测器和局部分支预测器去预测，然后根据它们的预测结果以及预测的指令地址，来更新自己的
索引表，这个表记录着若干的饱和计数器\upcite{r1}，饱和计数器的状态决定了全局分支预测器决定要采纳哪一种预测结果。
\begin{figure}[ht]
  \centering
    \includegraphics[width=\textwidth]{Merge.png}
    \caption{混合分支预测器\upcite{r1}}
    \label{fig:3}
  \end{figure}

\subsection{基于上述分支预测器的优化}
由于硬件方面的限制，上述分支预测器的索引不可能直接取到整个PC的大小，相对地，我们会采用记录PC低位的方法来作为表的索引。对于全局历史分支
预测器，还发展出了PC地址和GR记录做异或的方法来作为索引，这种做法能更好地避免冲突。但是受制于所写汇编程序的大小，相关的优化也就没有进行。
对于PC地址我做了对32取模，用来作为索引。

  
  \chapter{分支预测算法的软件实现与验证}
  
  \section{32位MIPS指令集实现}
  指令集方面我实现了所有32位MIPS指令:
      
    \begin{itemize}
      \item R型指令:add,addu,sub,subu,and,or,xor,nor,slt,sltu,sll,srl,sra,sllv,srlv,srav,jr
      \item I型指令:addi,addiu,andi,ori,xori,lui,lw,sw,beq,bne,slti,sltiu
      \item J型指令:j,jal
    \end{itemize}
    \par
    至于更具体的细节可以参考\url{http://blog.csdn.net/yixilee/article/details/4316617}
    在实现文件中，对读入的每条指令分解为opcode,rs,rt,rd,reserved等部分，
    从而实现对指令的译码，这一点与硬件上保持一致。关于软件的更多细节在此不再赘述，项目的详细文档可以在
    \url{https://github.com/xiejiangzhao/MIPS_Predict}获取，在此基础上还可以加入对x86指令集，新增其他预测方法的支持。\newpage
  
\section{不同预测方法的效果测试}
  以下对包括多重循环，排序算法等汇编代码进行了测试。\\
  \begin{figure}[ht]
    \centering
      \includegraphics[width=14cm]{Figure_1.png}
      \caption{冒泡排序预测结果}
      \label{fig:1}
    \end{figure}
  \begin{figure}[ht]
    \centering
      \includegraphics[width=14cm]{Figure_2.png}
      \caption{多层循环+TF变化预测结果}
      \label{fig:1}
    \end{figure}
  \begin{figure}[ht]
    \centering
      \includegraphics[width=14cm]{Figure_3.png}
      \caption{规律跳转预测结果}
      \label{fig:1}
    \end{figure}
  \section{预测结果评价}
  由预测结果，可见在不同的场景下预测器取得的效果是不同的，甚至差异性比较大。
  图表中值得留意的一点是，尽管混合分支预测器不能极大地提高正确率，但是预测效果较为稳定，在不同的场景下都能够取得
  相对优秀的结果。在实际生产环境中，跳转情景将会比上述情况更为复杂，这种不确定性都将会使得单一的分支预测效果
  不同程度下降，而混合分支预测器则能够较好地去拟合它们。

  %%%%============================================================================================================%%%
  
  \chapter{项目总结}
  
  
  %%%============================================================================================================%%%
  
  %%%=== 参考文献 ========%%%
  \cleardoublepage\phantomsection
  \addcontentsline{toc}{chapter}{参考文献}
  \begin{thebibliography}{00}
  
    \bibitem{r1} Scott McFarling,Combining Branch Predictors,WRL Technical Note TN-36, 1993.
  
    \bibitem{r2} Wikipedia,\url{https://en.wikipedia.org/wiki/Branch_predictor}.
  
    \bibitem{r3} 邓建松等, 《\LaTeXe~科技排版指南》, 科学出版社.
  
    \bibitem{r4} 吴凌云, 《CTeX~FAQ (常见问题集)》, \textit{Version~0.4}, June 21, 2004.
  
    \bibitem{r5} Herbert Vo\ss, Mathmode, \url{http://www.tex.ac.uk/ctan/info/math/voss/mathmode/Mathmode.pdf}.
  
  
  \end{thebibliography}
  
  \include{includefile/backmatter} %%%致谢
  
  %%%-------------- 附录. 不需要可以删除.-----------
  \appendix
  
  \chapter{测试}
  
  \section{第一个测试}
  测试公式编号
  \begin{equation}
  1+1=2.
  \end{equation}
  
  表格编号测试
  
  \begin{table}[h]
    \centering
    \caption{测试表格}
    \begin{tabular}{*{20}c}
       \hline
       % after \\: \hline or \cline{col1-col2} \cline{col3-col4} ...
       11 & 13  & 13  & 13  & 13 \\
       12 & 14  & 13  & 13  & 13 \\
       \hline
     \end{tabular}
  \end{table}
  
  
  \chapter{附录测试}
  
  测试
  
  \chapter{附录测试}
  
  测试
  
  \cleardoublepage
  \end{document}
  
  
  
  